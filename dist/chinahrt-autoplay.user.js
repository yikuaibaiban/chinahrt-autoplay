// ==UserScript==
// @name         chinahrt继续教育；chinahrt全自动刷课；解除系统限制；
// @version      2024.05.11.01
// @namespace    https://github.com/yikuaibaiban/chinahrt
// @description  【❤全自动刷课❤】功能可自由配置，只需将视频添加到播放列表，后续刷课由系统自动完成；使用教程：https://www.cnblogs.com/ykbb/p/16695563.html
// @author       yikuaibaiban
// @icon         data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAArFJREFUWEftlttPE0EUxr+9ddtdYOXSSmmlFFoasSFemmg0qYkIMfGF/9J/wTeN0cSYGBHEBBIoLSIU0VrKpe1eagaySWVmutu+GJPO4+5cfvOdc745wkGl3sI/HEIf4L9ToHrqoHLi4LTRgmm1IAhAMCDgmi4ibEgQhe4SyncOFA9tFMoWaucO9wRJFDAZlpCeUKAq/kA8AY7PHKwWmqic+i8WRRaQTciIj8qeFB0Bjo4dvN9ooOX/7L8OnLshYybaWQouALn5m/XeD3dJ5qcCSEQkrhJcgLfrdabshV8mvtdsPEoEPeV1JzzOqhjSROZ8JsBO2cJa0WQueLFSQ6lqYWpYQT4ZQnSQfzt3g+iwhFw64B/g9VqDm+0uANlNkYB8UkMupnqqkc+qMBgqUAqQOiex5412AHdOJhzAUlqDpvBNIBOXMTtBJyQF0El+ciALgHwfUEUspjTMjrGzPmKIuJ+hlaIA1ksmtg+srhRon7wwE0IuTieoHhTwZJ7+TgGsbDexe2T3DJAdV/E8o1HriTMu3QlR3ymAz4UmSj96A1AkActzOqZH6DD4BtjYM7G5130IYkMynmV0jHHqfXRQxMObPnKg/NvGh81mVyG4HQ1gcVYH22out5oel3Fr0kcVOC3g5cdz2JxH72oVPE1ruDfh7QMPMirCBo3IdMIvRfPi6WUNF2BMl0Aynjii1yAGRIyINZgADRN4tVa/aDiujnfFOg5PbCykNAyp/roPYsPEjn0DkInfflr4tMV+D7xu3P4/eV1GNsFXqWM/sLVv4usuvyK8QGIjEu6m2I+Qu9azIyKt2OoOvyp4EF439w1AJpLmhHjDfoVvUO6GJOHSMZkb86vAngq0L6ieOSA+UalddsWWfZmkA0ERhi4iYkjMUusUqq4AvGLey/8+QF+BP0npcPDdfTv7AAAAAElFTkSuQmCC
// @match        http://*.chinahrt.com/*
// @match        https://*.chinahrt.com/*
// @match        http://*.chinahrt.com.cn/*
// @match        https://*.chinahrt.com.cn/*
// @match        https://*.heb12333.cn/*
// @grant        unsafeWindow
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addValueChangeListener
// @grant        GM_notification
// ==/UserScript==
function autoPlay(e){return void 0!==e?(GM_setValue("autoPlay",e),e):GM_getValue("autoPlay",!0)}function mute(e){return void 0!==e?(GM_setValue("mute",e),e):GM_getValue("mute",!0)}function drag(e){return void 0!==attrset&&(attrset.ifCanDrag=1),e?(GM_setValue("drag",e),e):GM_getValue("drag",5)}function speed(e){return void 0!==attrset&&(attrset.playbackRate=1),e?(GM_setValue("speed",e),e):GM_getValue("speed",1)}function playMode(e){return void 0!==e?(GM_setValue("playMode",e),e):GM_getValue("playMode","loop")}function addCourse(e){var t=coursesList();return courseAdded(e.sectionId)?(notification(`课程 ${e.sectionName} 已经在播放列表中。`),!1):(t.push({...e,url:e.getUrl()}),coursesList(t),!0)}function removeCourse(t){var n=coursesList();for(let e=n.length-1;0<=e;e--)n[e].sectionId===t&&n.splice(e,1);coursesList(n)}function courseAdded(t){var n=coursesList();for(let e=0;e<n.length;e++)if(n[e].sectionId===t)return!0;return!1}function coursesList(e){return e?Array.isArray(e)?GM_setValue("courses",e):(notification("保存课程数据失败，数据格式异常。"),[]):(e=GM_getValue("courses",[]),Array.isArray(e)?e:[])}function interceptFetch(a){const o=window.fetch;window.fetch=function(t,n){var e=o(t,n);return e.then(e=>{a(t,e,n)}),e}}function interceptsXHR(i){const l=window.XMLHttpRequest.prototype.open;window.XMLHttpRequest.prototype.open=function(e,t,n,a,o){this.addEventListener("readystatechange",function(){i(t,this.response,e,this.readyState)}),l.apply(this,arguments)}}function notification(e){GM_notification({text:e,title:"Chinahrt自动刷课",image:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAArFJREFUWEftlttPE0EUxr+9ddtdYOXSSmmlFFoasSFemmg0qYkIMfGF/9J/wTeN0cSYGBHEBBIoLSIU0VrKpe1eagaySWVmutu+GJPO4+5cfvOdc745wkGl3sI/HEIf4L9ToHrqoHLi4LTRgmm1IAhAMCDgmi4ibEgQhe4SyncOFA9tFMoWaucO9wRJFDAZlpCeUKAq/kA8AY7PHKwWmqic+i8WRRaQTciIj8qeFB0Bjo4dvN9ooOX/7L8OnLshYybaWQouALn5m/XeD3dJ5qcCSEQkrhJcgLfrdabshV8mvtdsPEoEPeV1JzzOqhjSROZ8JsBO2cJa0WQueLFSQ6lqYWpYQT4ZQnSQfzt3g+iwhFw64B/g9VqDm+0uANlNkYB8UkMupnqqkc+qMBgqUAqQOiex5412AHdOJhzAUlqDpvBNIBOXMTtBJyQF0El+ciALgHwfUEUspjTMjrGzPmKIuJ+hlaIA1ksmtg+srhRon7wwE0IuTieoHhTwZJ7+TgGsbDexe2T3DJAdV/E8o1HriTMu3QlR3ymAz4UmSj96A1AkActzOqZH6DD4BtjYM7G5130IYkMynmV0jHHqfXRQxMObPnKg/NvGh81mVyG4HQ1gcVYH22out5oel3Fr0kcVOC3g5cdz2JxH72oVPE1ruDfh7QMPMirCBo3IdMIvRfPi6WUNF2BMl0Aynjii1yAGRIyINZgADRN4tVa/aDiujnfFOg5PbCykNAyp/roPYsPEjn0DkInfflr4tMV+D7xu3P4/eV1GNsFXqWM/sLVv4usuvyK8QGIjEu6m2I+Qu9azIyKt2OoOvyp4EF439w1AJpLmhHjDfoVvUO6GJOHSMZkb86vAngq0L6ieOSA+UalddsWWfZmkA0ERhi4iYkjMUusUqq4AvGLey/8+QF+BP0npcPDdfTv7AAAAAElFTkSuQmCC"})}function currentPageType(){return"/videoPlay/playEncrypt"===window.location.pathname||"/videoPlay/play"===window.location.pathname?2:"v_courseDetails"!==RegExp(/#\/(.+)\?/).exec(window.location.href)[1]?0:1}function createAutoPlayOption(){let a=document.createElement("div");a.classList.add("autoPlayBox");var e=document.createElement("p");e.classList.add("title"),e.innerText="自动播放",a.appendChild(e);return[{text:"是",value:!0},{text:"否",value:!1}].forEach(e=>{var t=document.createElement("label"),n=(t.innerText=e.text,a.appendChild(t),document.createElement("input"));n.type="radio",n.name="autoPlay",n.value=e.value,n.checked=autoPlay()===e.value,n.onclick=function(){autoPlay(e.value)},t.appendChild(n)}),a}function createCanPlaylist(){let o=document.createElement("div");o.id="canPlaylist",o.className="canPlaylist";var e=document.createElement("button");return e.innerText="一键添加",e.type="button",e.className="oneClick",e.onclick=function(){var e,t;for(e of o.getElementsByClassName("item"))for(t of e.getElementsByTagName("button"))"从播放列表移除"!==t.innerText&&t.click()},o.appendChild(e),o.addEventListener("clear",function(){var t=o.getElementsByClassName(".item");for(let e=t.length-1;0<=e;e--)t[e].remove()}),o.addEventListener("refresh",function(){var t=o.getElementsByClassName("item");for(let e=t.length-1;0<=e;e--){var n=t[e].getElementsByTagName("button")[0],a=courseAdded(n.getAttribute("data-sectionId"));n.innerText=a?"从播放列表移除":"添加到播放列表",n.className=a?"addBtn remove":"addBtn"}}),o.addEventListener("append",function(e){var t=document.createElement("div"),n=(t.className="item",this.appendChild(t),document.createElement("p")),n=(n.innerText=e.detail.sectionName,n.title=n.innerText,n.className="title",t.appendChild(n),document.createElement("p")),n=(n.innerText=e.detail.study_status,n.title=n.innerText,n.className="status",t.appendChild(n),courseAdded(e.detail.sectionId)),a=document.createElement("button");a.type="button",a.innerText=n?"从播放列表移除":"添加到播放列表",a.className=n?"addBtn remove":"addBtn",a.setAttribute("data-sectionId",e.detail.sectionId),a.onclick=function(){"从播放列表移除"===this.innerText?removeCourse(e.detail.sectionId):addCourse(e.detail)},t.appendChild(a)}),document.body.appendChild(o),o}function createDragOption(){let a=document.createElement("div");a.classList.add("dragBox");var e=document.createElement("p"),e=(e.classList.add("title"),e.innerText="拖动",a.appendChild(e),[{text:"还原",value:5},{text:"启用",value:1}].forEach(e=>{var t=document.createElement("label"),n=(t.innerText=e.text,a.appendChild(t),document.createElement("input"));n.type="radio",n.name="drag",n.value=e.value,n.checked=drag()===e.value,n.onclick=function(){drag(e.value)},t.appendChild(n)}),document.createElement("p"));return e.classList.add("remark"),e.innerText="注意：慎用此功能，后台可能会检测播放数据。",a.appendChild(e),a}function createMultiSegmentBox(){let a=document.createElement("div");a.className="multiSegmentBox",document.body.appendChild(a);var e=document.createElement("div");e.innerHTML="此功能只适用个别地区。无法使用的就不要使用了。<br/>网站会定期上传学习进度非必要别使用此功能。",e.className="tip",a.appendChild(e);[{text:"正常",value:0},{text:"二段播放",value:3,title:"将视频分为二段：开始，结束各播放90秒"},{text:"三段播放",value:1,title:"将视频分为三段：开始，中间，结束各播放90秒"},{text:"秒播",value:2,title:"将视频分为两段:开始，结束各播放一秒"}].forEach(e=>{var t=document.createElement("label"),n=(t.innerText=e.text,a.appendChild(t),document.createElement("input"));n.type="radio",n.name="playMode",n.value=e.value,n.checked=playMode()===e.value,n.onclick=function(){playMode(e.value)},t.appendChild(n)})}function timeHandler(e){var t,n,a,o=parseInt(player.getMetaDate().duration);if(1===playMode())return o<=270?void 0:(t=o/2-45,n=o/2+45,a=o-90,90<e&&e<t?void player.videoSeek(t):n<e&&e<a?void player.videoSeek(a):void 0);2===playMode()?1<e&&e<o-1&&player.videoSeek(o-1):3!==playMode()||o<=180||90<e&&e<o-90&&player.videoSeek(o-90)}function createMuteOption(){let a=document.createElement("div");a.classList.add("muteBox");var e=document.createElement("p"),e=(e.classList.add("title"),e.innerText="静音",a.appendChild(e),[{text:"是",value:!0},{text:"否",value:!1}].forEach(e=>{var t=document.createElement("label"),n=(t.innerText=e.text,a.appendChild(t),document.createElement("input"));n.type="radio",n.name="mute",n.value=e.value,n.checked=mute()===e.value,n.onclick=function(){mute(e.value)},t.appendChild(n)}),document.createElement("p"));return e.classList.add("remark"),e.innerText="注意：受浏览器策略影响，不静音，视频可能会出现不会自动播放",a.appendChild(e),a}function createControllerBox(){var e=document.createElement("div"),t=(e.id="controllerBox",e.className="controllerBox",document.body.appendChild(e),document.createElement("div"));t.className="linksBox",e.appendChild(t);for(const a of[{title:"使用教程",link:"https://www.cnblogs.com/ykbb/p/16695563.html"},{title:"留言",link:"https://msg.cnblogs.com/send/ykbb"},{title:"博客园",link:"https://www.cnblogs.com/ykbb/"},{title:"Gitee",link:"https://gitee.com/yikuaibaiban/chinahrt-autoplay/issues"},{title:"GitHub",link:"https://github.com/yikuaibaiban/chinahrt-autoplay/issues"}]){var n=document.createElement("a");n.innerText=a.title,n.target="_blank",n.href=a.link,t.appendChild(n)}return e.appendChild(createAutoPlayOption()),e.appendChild(createDragOption()),e.appendChild(createMuteOption()),e.appendChild(createSpeedOption()),e}function playerInit(){player.changeControlBarShow(!0),player.changeConfig("config","timeScheduleAdjust",drag()),mute()?player.videoMute():player.videoEscMute(),player.changePlaybackRate(speed()),autoPlay()&&player.videoPlay()}function playInit(){removePauseBlur(),createPlaylistBox(),createControllerBox(),createMultiSegmentBox(),GM_addValueChangeListener("courses",function(e,t,n,a){removePlaylistBox(),createPlaylistBox()});let e=setInterval(function(){player&&(clearInterval(e),player.removeListener("ended",endedHandler),GM_addValueChangeListener("autoPlay",function(e,t,n,a){n&&player.videoPlay()}),GM_addValueChangeListener("mute",function(e,t,n,a){n?player.videoMute():player.videoEscMute()}),GM_addValueChangeListener("drag",function(e,t,n,a){player.changeConfig("config","timeScheduleAdjust",n)}),GM_addValueChangeListener("speed",function(e,t,n,a){player.changePlaybackRate(n)}),playerInit(),player.addListener("ended",function(e){courseyunRecord(),player.videoClear(),$.ajax({url:"/videoPlay/takeRecord",data:{studyCode:attrset.studyCode,recordUrl:attrset.recordUrl,updateRedisMap:attrset.updateRedisMap,recordId:attrset.recordId,sectionId:attrset.sectionId,signId:attrset.signId,isEnd:!0,businessId:attrset.businessId},dataType:"json",type:"post",success:function(e){console.log("提交学习记录",e),removeCourse(attrset.sectionId);e=coursesList();0===e.length?notification("所有视频已经播放完毕"):(notification("即将播放下一个视频:"+e[0].sectionName),window.top.location.href=e[0].url)}})}),player.addListener("time",timeHandler))},500)}function createPlaylistBox(){var t=document.createElement("div"),e=(t.id="playlistBox",t.className="playlistBox",document.body.appendChild(t),document.createElement("button")),n=(e.innerText="一键清空",e.className="oneClear",e.onclick=function(){confirm("确定要清空播放列表么？")&&coursesList([])},t.appendChild(e),coursesList());for(let e=0;e<n.length;e++){const i=n[e];var a=document.createElement("div"),o=(a.className="playlistItem",t.appendChild(a),document.createElement("p")),o=(o.innerText=i.sectionName,o.title=o.innerText,o.className="child_title",a.appendChild(o),document.createElement("button"));o.innerText="移除",o.type="button",o.className="child_remove",o.onclick=function(){confirm("确定要删除这个视频任务么？")&&removeCourse(i.sectionId)},a.appendChild(o)}}function removePlaylistBox(){var e=document.getElementById("playlistBox");e&&e.remove()}function createSpeedOption(){let a=document.createElement("div");a.classList.add("speedBox");var e=document.createElement("p"),e=(e.classList.add("title"),e.innerText="播放速度",a.appendChild(e),[{text:"0.5x",value:.5},{text:"1x",value:1},{text:"1.25x",value:2},{text:"1.5x",value:3},{text:"2x",value:4}].forEach(e=>{var t=document.createElement("label"),n=(t.innerText=e.text,a.appendChild(t),document.createElement("input"));n.type="radio",n.name="speed",n.value=e.value,n.checked=speed()===e.value,n.onclick=function(){speed(e.value)},t.appendChild(n)}),document.createElement("p"));return e.classList.add("remark"),e.innerText="注意：慎用此功能，后台可能会检测播放数据。",a.appendChild(e),a}!function(){var e=document.createElement("style");e.appendChild(document.createTextNode(".autoPlayBox {    padding: 5px 10px;}.autoPlayBox .title {    color: blue;}.autoPlayBox label {    margin-right: 6px;}.autoPlayBox label input {    margin-left: 4px;}.canPlaylist {    width: 300px;    height: 500px;    position: fixed;    top: 100px;    background: rgba(255, 255, 255, 1);    right: 80px;    border: 1px solid #c1c1c1;    overflow-y: auto;}.canPlaylist .oneClick {    margin: 0 auto;    width: 100%;    border: none;    padding: 6px 0;    background: linear-gradient(180deg, #4BCE31, #4bccf2);    height: 50px;    border-radius: 5px;    color: #FFF;    font-weight: bold;    letter-spacing: 4px;    font-size: 18px;}.canPlaylist .item {    border-bottom: 1px solid #c1c1c1;    padding: 8px;    line-height: 150%;    border-bottom: 1px solid #c1c1c1;    margin-bottom: 3px;}.canPlaylist .item .title {    font-size: 13px;    white-space: nowrap;    overflow: hidden;    text-overflow: ellipsis;}.canPlaylist .item .status {    font-size: 12px;    white-space: nowrap;    overflow: hidden;    text-overflow: ellipsis;    color: #c90000;}.canPlaylist .item .addBtn {    color: #FFF;    background-color: #4bccf2;    border: none;    padding: 5px 10px;    margin-top: 4px;}.canPlaylist .item .addBtn.remove {    background-color: #fd1952;}.dragBox {    padding: 5px 10px;}.dragBox .title {    color: blue;}.dragBox .remark {    font-size: 12px;    color: #fc1818;}.dragBox label {    margin-right: 6px;}.dragBox label input {    margin-left: 4px;}.multiSegmentBox {    position: fixed;    right: 255px;    top: 0;    width: 250px;    height: 280px;    background-color: #FFF;    z-index: 9999;    border: 1px solid #ccc;    font-size: 12px;}.multiSegmentBox .tip {    border-bottom: 1px solid #ccc;    padding: 5px;    font-weight: bold;    color: red;}.multiSegmentBox .item {    font-size: 14px;}.multiSegmentBox label {    margin-right: 3px;}.multiSegmentBox label input {    margin-left: 2px;}.muteBox {    padding: 5px 10px;}.muteBox .title {    color: blue;}.muteBox .remark {    font-size: 12px;    color: #fc1818;}.muteBox label {    margin-right: 6px;}.muteBox label input {    margin-left: 4px;}.controllerBox {    position: fixed;    right: 0;    top: 0;    width: 250px;    height: 280px;    background-color: #FFF;    z-index: 9999;    border: 1px solid #ccc;    overflow-y: auto;    font-size: 12px;}.controllerBox .linksBox {    display: flex;    flex-wrap: wrap;    justify-content: space-between;    height: 30px;    line-height: 30px;    font-weight: bold;    border-bottom: 1px dotted;}.playlistBox {    position: fixed;    right: 0;    top: 290px;    width: 250px;    height: 450px;    background-color: #FFF;    z-index: 9999;    border: 1px solid #ccc;    overflow-y: auto;}.playlistBox .oneClear {    width: 100%;    border: none;    padding: 6px 0;    background: linear-gradient(180deg, #4BCE31, #4bccf2);    height: 50px;    border-radius: 5px;    color: #FFF;    font-weight: bold;    letter-spacing: 4px;    font-size: 18px;    cursor: pointer;    margin-bottom: 5px;}.playlistBox .playlistItem {    display: flex;    justify-content: space-between;    align-items: center;    margin-bottom: 5px;}.playlistBox .playlistItem .child_title {    font-size: 13px;    white-space: nowrap;    overflow: hidden;    text-overflow: ellipsis;    width: 180px;}.playlistBox .playlistItem .child_remove {    color: #FFF;    background-color: #fd1952;    border: none;    padding: 5px 10px;    cursor: pointer;}.speedBox {    padding: 5px 10px;}.speedBox .title {    color: blue;}.speedBox .remark {    font-size: 12px;    color: #fc1818;}.speedBox label {    margin-right: 6px;}.speedBox label input {    margin-left: 4px;}")),document.head.appendChild(e)}();let tempCourses=[];function interceptsXHRCallback(e,t,n,a){if(4===a&&e.includes("courseDetail")){let n=document.getElementById("canPlaylist");(n=null===n?createCanPlaylist():n).dispatchEvent(new CustomEvent("clear",{})),tempCourses=[];const o=JSON.parse(t);o.data.course.chapter_list.forEach(e=>{e.section_list.forEach(e=>{var t=new CourseDetail;t.courseId=o.data.courseId,t.sectionId=e.id,t.sectionName=e.name,t.trainplanId=o.data.trainplanId,t.study_status=e.study_status,tempCourses.push(t),n.dispatchEvent(new CustomEvent("append",{detail:t}))})})}}function interceptFetchCallback(e,t,n){t.json().then(e=>{})}function initRouter(){interceptsXHR(interceptsXHRCallback),interceptFetch(interceptFetchCallback),1===currentPageType()?GM_addValueChangeListener("courses",function(e,t,n,a){var o=document.getElementById("canPlaylist");o&&o.dispatchEvent(new CustomEvent("refresh",{}))}):2===currentPageType()&&playInit()}class CourseDetail{constructor(){this.trainplanId="",this.courseId="",this.sectionId="",this.sectionName="",this.study_status=""}getUrl(){var e=RegExp(/platformId=(\d+)/).exec(window.location.href)[1];return`https://${window.location.host}/index.html#/v_video?platformId=${e}&trainplanId=${this.trainplanId}&courseId=${this.courseId}&sectionId=${this.sectionId}&sectionName=`+encodeURI(this.sectionName)}}!async function(){initRouter()}();